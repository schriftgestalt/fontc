# `fontc_crater`

The `fontc_crater` crate (named after [rust-lang/crater]) is a tool for
performing compilation and related actions across a large number of source
fonts.

Discovery of font sources is managed by a separate tool,
[google-fonts-sources][]; this tool checks out the
[github.com/google/fonts][google/fonts] repository and looks for fonts with
known source repos. You can use the `--fonts-repo` argument to pass the path to
an existing checkout of this repository, which saves time.

((TODO: The `--fonts-repo` argument seems to have been removed))

Once sources are identified, they are checked out into a cache directory, where
they can be reused between runs.

## CI

This tool is mainly used in CI. In that case, the execution is managed by a
script in the [`fontc_crater` repo][crater-repo] and results are posted to
[github pages][crater-results].

To run in CI mode locally to play with the HTML output or to compare binaries
generated by Glyphs 3 and Glyphs 4:

### Update Python packages

We want to ensure that we have complete control over the set of Python pacakges
we are comparing against; to ensure this we use `pip-compile` (part of 
[`pip-tools`]) to generate a pinned `requirements.txt` from a `requirements.in`
file in the root `resources/scripts` directory.

To update the set of Python packages in use, you need to update this file:

```shell
# Make sure you have pip-tools
$ python -m pip install pip-tools

# Rebuild the file
# Remove it to force a complete update rather than minimal
$ rm -f resources/scripts/requirements.txt && pip-compile resources/scripts/requirements.in

# Commit updated file
```

### Create JSON with list of font repositories

This file will be used as input for the CI run:

```shell
# Assuming this repository has been checked out:
$ cd google-fonts-sources

# Compile a list of repositories and save them as JSON:
$ RUST_LOG=INFO cargo run -- -o targets.json /optional/directory/path
```

### Run locally

To rebuild the HTML:

```shell
# Clone git@github.com:googlefonts/fontc_crater.git somewhere, we'll assume at ../fontc_crater
# This also works with the entire `fontc` repository.
# CI currently has its own format for the repo list, use the file from ^

$ RUST_LOG=debug cargo run --release -p fontc_crater \
-- ci ../fontc_crater/targets.json -o ../fontc_crater/results/ --html-only

# Review ../fontc_crater/results/index.html (NOT ../fontc_crater/index.html)
```

To do a full run, such as to test a PR (assuming same `fontc_crater` checkout
as above):

```shell
# Make sure the repo is up to date, so you're comparing against the latest run:
# cd ../fontc_crater && git pull

$ RUST_LOG=debug cargo run --release -p fontc_crater \
-- ci ../fontc_crater/targets.json --out ../fontc_crater/results/

```

To display further usage information and a list of other arguments, including
custom cache location and Glyphs app mode:

```shell
$ cargo run --release -p fontc_crater ci --help
```

[google-fonts-sources]: https://github.com/googlefonts/google-fonts-sources
[google/fonts]: https://github.com/google/fonts
[rust-lang/crater]: https://github.com/rust-lang/crater
[crater-repo]: https://github.com/googlefonts/fontc_crater
[crater-results]: https://googlefonts.github.io/fontc_crater/
[`pip-tools`]: https://github.com/jazzband/pip-tools
